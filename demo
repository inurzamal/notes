import { Component, OnInit, ViewChild, OnDestroy } from '@angular/core';
import { UntypedFormControl, Validators } from '@angular/forms';
import { MatTableDataSource } from '@angular/material/table';
import { HttpClient } from '@angular/common/http';
import { MatSort } from '@angular/material/sort';
import { MatPaginator } from '@angular/material/paginator';
import { Subscription } from 'rxjs';

// Define RatingElement interface for typing
export interface RatingElement {
  name: string;
  type: string;
  position: number;
  weight: number;
  symbol: string;
  createdt: Date;
  users: any;
}

@Component({
  selector: 'app-rating-action',
  templateUrl: './rating-action.component.html',
  styleUrls: ['./rating-action.component.scss']
})
export class RatingActionComponent implements OnInit, OnDestroy {
  selectedCountry: string;
  requiredpickerInput = new UntypedFormControl('', [Validators.required]);
  fromDatePickerInput = new UntypedFormControl('', [Validators.required]);
  toDatePickerInput = new UntypedFormControl('', [Validators.required]);

  @ViewChild(MatSort, { static: true }) sort: MatSort;
  @ViewChild(MatPaginator, { static: true }) paginator: MatPaginator;

  countries: string[] = [];
  displayedColumns: string[] = ['country', 'ratingdate', 'oldcrr', 'oldcrroutlook', 'oldcrg', 'newcrr', 'newcrroutlook', 'newcrg', 'ratingcomment'];
  dataSource = new MatTableDataSource<RatingElement>();
  private subscription: Subscription;

  // Sample data
  headerMapping = {
    country: 'Country',
    ratingdate: 'Rating Date',
    oldcrr: 'Old CRR',
    oldcrroutlook: 'Old CRR Outlook',
    oldcrg: 'Old CRG',
    newcrr: 'New CRR',
    newcrroutlook: 'New CRR Outlook',
    newcrg: 'New CRG',
    ratingcomment: 'Rating Comment'
  }

  constructor(private http: HttpClient) {}

  ngOnInit(): void {
    this.getdata();
  }

  getdata() {
    this.http.get<RatingElement[]>('../../../assets/json/ratingaction.json').subscribe((response) => {
      this.dataSource.data = response;
      this.countries = [...new Set(response.map(data => data.country))];

      // Set paginator and sorter after data is set
      this.dataSource.paginator = this.paginator;
      this.dataSource.sort = this.sort;
    });
  }

  showData() {
    this.http.get<RatingElement[]>('../../../assets/json/ratingaction.json', {
      params: {
        country: this.selectedCountry,
        fromUpdateDate: this.fromDatePickerInput.value,
        toUpdateDate: this.toDatePickerInput.value
      }
    }).subscribe((response) => {
      this.dataSource.data = response;

      // Set paginator and sorter after data is set
      this.dataSource.paginator = this.paginator;
      this.dataSource.sort = this.sort;
    });
  }

  ngOnDestroy(): void {
    if (this.subscription) {
      this.subscription.unsubscribe();
    }
  }
}
